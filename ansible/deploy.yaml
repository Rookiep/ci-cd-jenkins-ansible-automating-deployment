---
- name: Deploy application to Minikube
  hosts: localhost
  vars:
    image_tag: "{{ image_tag | default('latest') }}"
  
  tasks:
    - name: Create Kubernetes deployment
      shell: |
        cat > /tmp/deployment.yaml << EOF
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: myapp
        spec:
          replicas: 2
          selector:
            matchLabels:
              app: myapp
          template:
            metadata:
              labels:
                app: myapp
            spec:
              containers:
              - name: myapp
                image: myapp:{{ image_tag }}
                ports:
                - containerPort: 5000
        EOF
        
        kubectl apply -f /tmp/deployment.yaml
      args:
        executable: /bin/bash
      register: deploy_result
      ignore_errors: yes

    - name: Create Kubernetes service
      shell: |
        cat > /tmp/service.yaml << EOF
        apiVersion: v1
        kind: Service
        metadata:
          name: myapp-service
        spec:
          selector:
            app: myapp
          ports:
          - protocol: TCP
            port: 80
            targetPort: 5000
          type: LoadBalancer
        EOF
        
        kubectl apply -f /tmp/service.yaml
      args:
        executable: /bin/bash
      register: service_result
      ignore_errors: yes

    - name: Display deployment status
      debug:
        msg: |
          ðŸš€ DEPLOYMENT STATUS
          ===================
          Image: myapp:{{ image_tag }}
          Deployment: {{ deploy_result is failed and 'FAILED' or 'APPLIED' }}
          Service: {{ service_result is failed and 'FAILED' or 'APPLIED' }}
          
          {% if not deploy_result is failed and not service_result is failed %}
          âœ… Successfully deployed to Minikube!
          ðŸ’¡ Check with: kubectl get pods && kubectl get services
          {% else %}
          âš ï¸  Deployment failed - Jenkins cannot access Minikube
          ðŸ’¡ Deploy manually using the YAML files in /tmp/
          {% endif %}