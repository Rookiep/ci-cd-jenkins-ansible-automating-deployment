---
- name: Deploy application to Kubernetes
  hosts: localhost
  vars:
    image_tag: "{{ image_tag | default('latest') }}"
  
  tasks:
    - name: Deploy application using kubectl
      shell: |
        # Set Minikube docker environment
        eval $(minikube docker-env)
        
        # Build image
        docker build -t myapp:{{ image_tag }} .
        
        # Apply deployment
        kubectl apply -f - <<EOF
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: myapp
        spec:
          replicas: 2
          selector:
            matchLabels:
              app: myapp
          template:
            metadata:
              labels:
                app: myapp
            spec:
              containers:
              - name: myapp
                image: myapp:{{ image_tag }}
                ports:
                - containerPort: 5000
        ---
        apiVersion: v1
        kind: Service
        metadata:
          name: myapp-service
        spec:
          selector:
            app: myapp
          ports:
          - protocol: TCP
            port: 80
            targetPort: 5000
          type: LoadBalancer
        EOF
      args:
        executable: /bin/bash
      register: deploy_result
      ignore_errors: yes

    - name: Get application URL
      shell: minikube service myapp-service --url
      register: app_url
      ignore_errors: yes

    - name: Show deployment status
      debug:
        msg: |
          âœ… DEPLOYMENT COMPLETE
          =====================
          Image: myapp:{{ image_tag }}
          Status: {{ deploy_result.rc == 0 | ternary('SUCCESS', 'CHECK_MANUAL') }}
          {% if app_url.stdout %}
          ðŸ”— Application URL: {{ app_url.stdout }}
          {% else %}
          ðŸ’¡ Run: minikube service myapp-service --url
          {% endif %}