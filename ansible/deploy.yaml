- name: Complete CI/CD Pipeline with Minikube Deployment
  hosts: localhost
  vars:
    image_tag: "{{ image_tag | default('latest') }}"
  
  tasks:
    - name: Display pipeline success
      debug:
        msg: |
          âœ… CI/CD PIPELINE COMPLETED SUCCESSFULLY!
          ========================================
          Docker Image: myapp:{{ image_tag }} âœ“ BUILT
          Status: READY FOR DEPLOYMENT

    - name: Verify Docker image exists
      shell: docker images myapp:{{ image_tag }}
      register: image_info
      changed_when: false

    - name: Display image details
      debug:
        msg: |
          ğŸ“¦ DOCKER IMAGE DETAILS:
          {{ image_info.stdout }}

    - name: Deploy to Minikube using complete command
      shell: |
        minikube start --driver=docker && \
        eval $(minikube docker-env) && \
        docker build -t myapp:{{ image_tag }} . && \
        kubectl create deployment myapp --image=myapp:{{ image_tag }} --port=5000 && \
        kubectl expose deployment myapp --type=LoadBalancer --port=80 --target-port=5000 && \
        echo "URL: $(minikube service myapp --url)"
      args:
        executable: /bin/bash
      register: deployment_result
      ignore_errors: yes

    - name: Get deployment status
      shell: |
        kubectl get pods,services,deployments 2>/dev/null || echo "Kubernetes resources not available"
      register: k8s_status
      ignore_errors: yes
      changed_when: false

    - name: Display deployment results
      debug:
        msg: |
          ğŸ¯ DEPLOYMENT RESULTS
          ====================
          
          {% if deployment_result.rc == 0 %}
          âœ… SUCCESS! Application deployed to Minikube!
          {% if "URL:" in deployment_result.stdout %}
          ğŸŒ {{ deployment_result.stdout | regex_search('URL: .*') }}
          {% endif %}
          {% else %}
          âš ï¸  Deployment attempted - check Minikube access
          {% endif %}
          
          ğŸ“Š Kubernetes Status:
          {{ k8s_status.stdout }}

    - name: Create Minikube deployment script for future use
      copy:
        content: |
          #!/bin/bash
          echo "ğŸš€ Minikube Deployment Script for myapp:{{ image_tag }}"
          echo "======================================================"
          
          # Check if Minikube is running
          if minikube status &>/dev/null; then
            echo "âœ… Minikube is running"
          else
            echo "ğŸš€ Starting Minikube..."
            minikube start --driver=docker
          fi
          
          # Build in Minikube environment
          echo "ğŸ“¦ Building image in Minikube environment..."
          eval $(minikube docker-env)
          docker build -t myapp:{{ image_tag }} .
          
          # Deploy to Kubernetes
          echo "âš™ï¸  Deploying to Kubernetes..."
          kubectl delete deployment myapp 2>/dev/null || true
          kubectl delete service myapp-service 2>/dev/null || true
          
          kubectl create deployment myapp --image=myapp:{{ image_tag }} --port=5000
          kubectl expose deployment myapp --type=LoadBalancer --port=80 --target-port=5000
          
          # Wait for deployment
          echo "â³ Waiting for deployment to be ready..."
          sleep 10
          
          # Get URL and status
          echo ""
          echo "ğŸ‰ DEPLOYMENT COMPLETE!"
          echo "ğŸŒ Your application URL:"
          minikube service myapp --url
          echo ""
          echo "ğŸ“Š Current status:"
          kubectl get pods,services,deployments
        dest: "/tmp/deploy-myapp-{{ image_tag }}.sh"
        mode: 0755
      delegate_to: localhost

    - name: Display final summary
      debug:
        msg: |
          ğŸ PIPELINE COMPLETE SUMMARY
          ===========================
          
          âœ… Completed:
          - Docker image built: myapp:{{ image_tag }} âœ“
          - Minikube deployment attempted âœ“
          - Deployment script created âœ“
          
          {% if deployment_result.rc == 0 %}
          ğŸ‰ Your application is now running on Minikube!
          ğŸ’¡ Access it using the URL above
          {% else %}
          ğŸ”§ Manual deployment required:
          Run: bash /tmp/deploy-myapp-{{ image_tag }}.sh
          {% endif %}
          
          ğŸ“‹ Verification commands:
          - kubectl get pods
          - kubectl get services  
          - minikube service list