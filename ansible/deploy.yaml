---
- name: Deploy application to Kubernetes
  hosts: localhost
  vars:
    image_tag: "{{ image_tag | default('latest') }}"
  
  tasks:
    - name: Check Kubernetes accessibility
      shell: kubectl cluster-info 2>/dev/null && echo "accessible" || echo "not_accessible"
      register: k8s_check
      changed_when: false
      ignore_errors: yes

    - name: Create Kubernetes deployment manifest
      copy:
        content: |
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: myapp
          spec:
            replicas: 2
            selector:
              matchLabels:
                app: myapp
            template:
              metadata:
                labels:
                  app: myapp
              spec:
                containers:
                - name: myapp
                  image: myapp:{{ image_tag }}
                  ports:
                  - containerPort: 5000
        dest: "/tmp/deployment-{{ image_tag }}.yaml"
      delegate_to: localhost

    - name: Create Kubernetes service manifest
      copy:
        content: |
          apiVersion: v1
          kind: Service
          metadata:
            name: myapp-service
          spec:
            selector:
              app: myapp
            ports:
            - protocol: TCP
              port: 80
              targetPort: 5000
            type: LoadBalancer
        dest: "/tmp/service-{{ image_tag }}.yaml"
      delegate_to: localhost

    - name: Apply Kubernetes manifests if accessible
      shell: |
        kubectl apply -f /tmp/deployment-{{ image_tag }}.yaml
        kubectl apply -f /tmp/service-{{ image_tag }}.yaml
      when: k8s_check.stdout == "accessible"
      register: k8s_result
      ignore_errors: yes

    - name: Display final status
      debug:
        msg: |
          ðŸŽ‰ DEPLOYMENT COMPLETE
          ======================
          Docker Image: myapp:{{ image_tag }}
          Kubernetes: {{ k8s_check.stdout }}
          {% if k8s_check.stdout == "accessible" %}
          âœ… Applied to Kubernetes successfully!
          {% else %}
          ðŸ“‹ Manifests ready in /tmp/ directory
          ðŸ’¡ Apply manually: kubectl apply -f /tmp/
          {% endif %}