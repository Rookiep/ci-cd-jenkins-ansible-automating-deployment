---
- name: Deploy application to Kubernetes
  hosts: localhost
  gather_facts: yes
  vars:
    image_tag: "{{ lookup('env', 'IMAGE_TAG') | default('latest') }}"
  
  tasks:
    - name: Check Kubernetes cluster accessibility
      shell: |
        kubectl cluster-info 2>/dev/null && echo "accessible" || echo "not_accessible"
      register: cluster_check
      changed_when: false
      ignore_errors: yes

    - name: Set Kubernetes context automatically
      shell: |
        # Try to use minikube context if it exists
        if kubectl config get-contexts -o name | grep -q minikube; then
          kubectl config use-context minikube
          echo "minikube"
        else
          # Use the first available context
          kubectl config get-contexts -o name | head -1 | xargs kubectl config use-context
          kubectl config current-context
        fi
      when: cluster_check.stdout == "accessible"
      register: context_used
      ignore_errors: yes

    - name: Update deployment manifest with current image tag
      replace:
        path: kubernetes/deployment.yaml
        regex: 'image: myapp:.*'
        replace: 'image: myapp:{{ image_tag }}'
      delegate_to: localhost

    - name: Display deployment information
      debug:
        msg: |
          ðŸš€ Kubernetes Deployment
          ========================
          Image Tag: {{ image_tag }}
          Cluster: {{ cluster_check.stdout }}
          Context: {{ context_used.stdout | default('not_set') }}
          Manifests: 
            - kubernetes/deployment.yaml
            - kubernetes/service.yaml

    - name: Apply Kubernetes deployment
      shell: kubectl apply -f kubernetes/deployment.yaml
      when: cluster_check.stdout == "accessible"
      register: deployment_result
      ignore_errors: yes

    - name: Apply Kubernetes service
      shell: kubectl apply -f kubernetes/service.yaml
      when: cluster_check.stdout == "accessible"
      register: service_result
      ignore_errors: yes

    - name: Show deployment simulation
      debug:
        msg: |
          ðŸ“‹ DEPLOYMENT SIMULATION (Kubernetes not accessible)
          ===================================================
          Would apply:
          - kubectl apply -f kubernetes/deployment.yaml
          - kubectl apply -f kubernetes/service.yaml
          With image: myapp:{{ image_tag }}
      when: cluster_check.stdout != "accessible"

    - name: Display deployment results
      debug:
        msg: |
          âœ… DEPLOYMENT RESULTS
          ====================
          Deployment: {{ deployment_result is skipped and 'SIMULATED' or deployment_result.stdout }}
          Service: {{ service_result is skipped and 'SIMULATED' or service_result.stdout }}
          Status: {{ (cluster_check.stdout == "accessible") | ternary('APPLIED', 'SIMULATED') }}
