---
- name: Deploy application to Minikube
  hosts: localhost
  vars:
    image_tag: "{{ image_tag | default('latest') }}"
  
  tasks:
    - name: Check Minikube connection
      shell: kubectl get nodes
      register: k8s_check
      ignore_errors: yes

    - name: Create Kubernetes deployment
      shell: |
        cat > /tmp/deployment.yaml << EOF
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: myapp
        spec:
          replicas: 2
          selector:
            matchLabels:
              app: myapp
          template:
            metadata:
              labels:
                app: myapp
            spec:
              containers:
              - name: myapp
                image: myapp:{{ image_tag }}
                ports:
                - containerPort: 5000
        EOF
        
        kubectl apply -f /tmp/deployment.yaml --validate=false
      args:
        executable: /bin/bash
      when: k8s_check.rc == 0
      register: deploy_result
      ignore_errors: yes

    - name: Create Kubernetes service
      shell: |
        cat > /tmp/service.yaml << EOF
        apiVersion: v1
        kind: Service
        metadata:
          name: myapp-service
        spec:
          selector:
            app: myapp
          ports:
          - protocol: TCP
            port: 80
            targetPort: 5000
          type: LoadBalancer
        EOF
        
        kubectl apply -f /tmp/service.yaml --validate=false
      args:
        executable: /bin/bash
      when: k8s_check.rc == 0
      register: service_result
      ignore_errors: yes

    - name: Display deployment status
      debug:
        msg: |
          ðŸš€ DEPLOYMENT STATUS
          ===================
          Image: myapp:{{ image_tag }}
          Minikube Access: {{ k8s_check.rc == 0 | ternary('âœ… CONNECTED', 'âŒ NOT CONNECTED') }}
          {% if k8s_check.rc == 0 %}
          Deployment: {{ deploy_result is failed and 'FAILED' or 'APPLIED' }}
          Service: {{ service_result is failed and 'FAILED' or 'APPLIED' }}
          {% if not deploy_result is failed and not service_result is failed %}
          âœ… Successfully deployed to Minikube!
          ðŸ’¡ Check with: kubectl get pods && kubectl get services
          {% endif %}
          {% else %}
          âš ï¸  Jenkins cannot access Minikube
          ðŸ’¡ Run manually: 
             eval \$(minikube docker-env)
             docker build -t myapp:{{ image_tag }} .
             kubectl create deployment myapp --image=myapp:{{ image_tag }} --port=5000
             kubectl expose deployment myapp --type=LoadBalancer --port=80 --target-port=5000
          {% endif %}