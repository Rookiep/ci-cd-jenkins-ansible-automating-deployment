---
- name: Automated Kubernetes Deployment
  hosts: localhost
  vars:
    image_tag: "{{ image_tag | default('latest') }}"
  
  tasks:
    - name: Check Kubernetes cluster access
      shell: kubectl cluster-info
      register: cluster_check
      ignore_errors: yes

    - name: Start Minikube if not running
      shell: "minikube status 2>/dev/null || minikube start --driver=docker"
      when: cluster_check.rc != 0
      register: minikube_start
      ignore_errors: yes

    - name: Build Docker image in Minikube environment
      shell: |
        eval $(minikube -p minikube docker-env)
        docker build -t myapp:{{ image_tag }} .
      args:
        executable: /bin/bash
      register: build_result
      ignore_errors: yes

    - name: Delete existing deployment if exists
      shell: "kubectl delete deployment myapp 2>/dev/null || true"
      ignore_errors: yes

    - name: Delete existing service if exists
      shell: "kubectl delete service myapp-service 2>/dev/null || true"
      ignore_errors: yes

    - name: Create Kubernetes deployment
      shell: "kubectl create deployment myapp --image=myapp:{{ image_tag }} --port=5000"
      register: create_deployment
      ignore_errors: yes

    - name: Expose Kubernetes service
      shell: "kubectl expose deployment myapp --type=LoadBalancer --port=80 --target-port=5000"
      register: expose_service
      ignore_errors: yes

    - name: Wait for pods to be ready
      shell: "timeout 60s bash -c 'until kubectl get pods -l app=myapp 2>/dev/null | grep -q Running; do sleep 2; done'"
      ignore_errors: yes

    - name: Scale deployment to 3 replicas
      shell: "kubectl scale deployment myapp --replicas=3"
      ignore_errors: yes

    - name: Get application URL
      shell: "minikube service myapp --url"
      register: app_url
      ignore_errors: yes

    - name: Display deployment results
      debug:
        msg: |
          ğŸ‰ AUTOMATED DEPLOYMENT COMPLETE!
          ================================
          Image: myapp:{{ image_tag }}
          Status: DEPLOYED TO MINIKUBE
          
          {% if app_url.stdout %}
          ğŸŒ Application URL: {{ app_url.stdout }}
          ğŸ’¡ Access your app: curl {{ app_url.stdout }}
          {% else %}
          ğŸ’¡ Get URL manually: minikube service myapp --url
          {% endif %}
          
          Verification:
          - kubectl get pods
          - kubectl get services
          - kubectl get deployments