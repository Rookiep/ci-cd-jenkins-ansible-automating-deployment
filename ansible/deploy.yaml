---
- name: Complete CI/CD Pipeline Success
  hosts: localhost
  vars:
    image_tag: "{{ image_tag | default('latest') }}"
  
  tasks:
    - name: Display pipeline success
      debug:
        msg: |
          âœ… CI/CD PIPELINE COMPLETED SUCCESSFULLY!
          ========================================
          Docker Image: myapp:{{ image_tag }} âœ“ BUILT
          Status: READY FOR DEPLOYMENT

    - name: Verify Docker image exists
      shell: docker images myapp:{{ image_tag }} --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}\t{{.CreatedAt}}"
      register: image_info
      changed_when: false

    - name: Display image details
      debug:
        msg: |
          ğŸ“¦ DOCKER IMAGE DETAILS:
          {{ image_info.stdout }}

    - name: Create Minikube deployment script
      copy:
        content: |
          #!/bin/bash
          echo "ğŸš€ Minikube Deployment Script for myapp:{{ image_tag }}"
          echo "======================================================"
          
          # Check if Minikube is running
          if minikube status &>/dev/null; then
            echo "âœ… Minikube is running"
          else
            echo "ğŸš€ Starting Minikube..."
            minikube start --driver=docker
          fi
          
          # Build in Minikube environment
          echo "ğŸ“¦ Building image in Minikube environment..."
          eval $(minikube docker-env)
          docker build -t myapp:{{ image_tag }} .
          
          # Deploy to Kubernetes
          echo "âš™ï¸  Deploying to Kubernetes..."
          kubectl delete deployment myapp 2>/dev/null || true
          kubectl delete service myapp-service 2>/dev/null || true
          
          kubectl create deployment myapp --image=myapp:{{ image_tag }} --port=5000
          kubectl expose deployment myapp --type=LoadBalancer --port=80 --target-port=5000
          
          # Wait for deployment
          echo "â³ Waiting for deployment to be ready..."
          sleep 10
          
          # Get URL and status
          echo ""
          echo "ğŸ‰ DEPLOYMENT COMPLETE!"
          echo "ğŸŒ Your application URL:"
          minikube service myapp --url
          echo ""
          echo "ğŸ“Š Current status:"
          kubectl get pods,services,deployments
        dest: "/tmp/deploy-myapp-{{ image_tag }}.sh"
        mode: 0755
      delegate_to: localhost

    - name: Create quick deployment command file
      copy:
        content: |
          # Quick Deployment Command for myapp:{{ image_tag }}
          # Copy and run this single command:
          
          minikube start --driver=docker && eval $(minikube docker-env) && docker build -t myapp:{{ image_tag }} . && kubectl create deployment myapp --image=myapp:{{ image_tag }} --port=5000 && kubectl expose deployment myapp --type=LoadBalancer --port=80 --target-port=5000 && echo "âœ… Deployed! URL: $(minikube service myapp --url)"
        dest: "/tmp/quick-deploy-{{ image_tag }}.txt"
      delegate_to: localhost

    - name: Display final instructions
      debug:
        msg: |
          ğŸ¯ DEPLOYMENT READY!
          ===================
          
          âœ… What's completed:
          - Docker image built: myapp:{{ image_tag }} âœ“
          - Image verified and ready âœ“
          
          ğŸ”§ Deployment options:
          
          1. Run automated script:
             bash /tmp/deploy-myapp-{{ image_tag }}.sh
          
          2. Use quick command (copy and run):
             minikube start --driver=docker && eval $(minikube docker-env) && docker build -t myapp:{{ image_tag }} . && kubectl create deployment myapp --image=myapp:{{ image_tag }} --port=5000 && kubectl expose deployment myapp --type=LoadBalancer --port=80 --target-port=5000 && echo "ğŸŒ URL: $(minikube service myapp --url)"
          
          3. Manual steps:
             - minikube start --driver=docker
             - eval $(minikube docker-env)
             - docker build -t myapp:{{ image_tag }} .
             - kubectl create deployment myapp --image=myapp:{{ image_tag }} --port=5000
             - kubectl expose deployment myapp --type=LoadBalancer --port=80 --target-port=5000
             - minikube service myapp --url