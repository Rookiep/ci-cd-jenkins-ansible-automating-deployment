---
- name: Complete CI/CD Pipeline Success
  hosts: localhost
  vars:
    image_tag: "{{ image_tag | default('latest') }}"
  
  tasks:
    - name: Display pipeline success
      debug:
        msg: |
          âœ… CI/CD PIPELINE COMPLETED SUCCESSFULLY!
          ========================================
          Docker Image: myapp:{{ image_tag }} âœ“ BUILT
          Status: READY FOR DEPLOYMENT

    - name: Verify Docker image exists
      shell: docker images myapp:{{ image_tag }}
      register: image_info
      changed_when: false

    - name: Display image details
      debug:
        msg: |
          ğŸ“¦ DOCKER IMAGE DETAILS:
          {{ image_info.stdout }}

    - name: Create complete deployment package
      copy:
        content: |
          # MINIKUBE DEPLOYMENT PACKAGE
          # Generated by Jenkins CI/CD Pipeline
          # Image: myapp:{{ image_tag }}
          # Date: {{ ansible_date_time.iso8601 }}

          DEPLOYMENT COMMANDS:
          ===================

          1. QUICK DEPLOY (One Command):
          minikube start --driver=docker && eval $(minikube docker-env) && docker build -t myapp:{{ image_tag }} . && kubectl create deployment myapp --image=myapp:{{ image_tag }} --port=5000 && kubectl expose deployment myapp --type=LoadBalancer --port=80 --target-port=5000 && echo "ğŸŒ URL: $(minikube service myapp --url)"

          2. STEP-BY-STEP:
          - minikube start --driver=docker
          - eval $(minikube docker-env)
          - docker build -t myapp:{{ image_tag }} .
          - kubectl create deployment myapp --image=myapp:{{ image_tag }} --port=5000
          - kubectl expose deployment myapp --type=LoadBalancer --port=80 --target-port=5000
          - minikube service myapp --url

          VERIFICATION COMMANDS:
          =====================
          kubectl get pods
          kubectl get services
          kubectl get deployments
          minikube service list

          DOCKER IMAGE:
          ============
          {{ image_info.stdout }}
        dest: "/tmp/deployment-instructions-{{ image_tag }}.txt"
      delegate_to: localhost

    - name: Create automated deployment script
      copy:
        content: |
          #!/bin/bash
          echo "ğŸš€ Automated Minikube Deployment for myapp:{{ image_tag }}"
          echo "=========================================================="
          echo ""
          
          # Start Minikube
          echo "ğŸ”§ Starting Minikube..."
          minikube start --driver=docker
          
          # Build in Minikube environment
          echo "ğŸ“¦ Building Docker image..."
          eval $(minikube docker-env)
          docker build -t myapp:{{ image_tag }} .
          
          # Deploy to Kubernetes
          echo "âš™ï¸  Deploying to Kubernetes..."
          kubectl delete deployment myapp 2>/dev/null || true
          kubectl delete service myapp-service 2>/dev/null || true
          
          kubectl create deployment myapp --image=myapp:{{ image_tag }} --port=5000
          kubectl expose deployment myapp --type=LoadBalancer --port=80 --target-port=5000
          
          # Wait and get URL
          echo "â³ Waiting for deployment..."
          sleep 15
          
          echo ""
          echo "ğŸ‰ DEPLOYMENT COMPLETE!"
          echo "ğŸŒ Application URL:"
          minikube service myapp --url
          echo ""
          echo "ğŸ“Š Status:"
          kubectl get pods,services
        dest: "/tmp/deploy-myapp-{{ image_tag }}.sh"
        mode: 0755
      delegate_to: localhost

    - name: Display final instructions
      debug:
        msg: |
          ğŸ CI/CD PIPELINE COMPLETE!
          ===========================
          
          âœ… SUCCESS:
          - Docker image built: myapp:{{ image_tag }} âœ“
          - Deployment package created âœ“
          - Automated script ready âœ“
          
          ğŸš€ NEXT STEPS:
          
          1. QUICK DEPLOYMENT:
             Copy and run this single command on your host:
             
             minikube start --driver=docker && eval $(minikube docker-env) && docker build -t myapp:{{ image_tag }} . && kubectl create deployment myapp --image=myapp:{{ image_tag }} --port=5000 && kubectl expose deployment myapp --type=LoadBalancer --port=80 --target-port=5000 && echo "URL: $(minikube service myapp --url)"
          
          2. USE AUTOMATED SCRIPT:
             bash /tmp/deploy-myapp-{{ image_tag }}.sh
          
          3. VIEW INSTRUCTIONS:
             cat /tmp/deployment-instructions-{{ image_tag }}.txt
          
          ğŸ’¡ Your application will be running at the provided URL!