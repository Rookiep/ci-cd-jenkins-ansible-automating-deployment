---
- name: Complete CI/CD Pipeline with Minikube Preparation
  hosts: localhost
  vars:
    image_tag: "{{ image_tag | default('latest') }}"
  
  tasks:
    - name: Display pipeline start
      debug:
        msg: |
          ğŸš€ CI/CD PIPELINE EXECUTION
          ===========================
          Building and preparing: myapp:{{ image_tag }}

    - name: Build Docker image locally (for verification)
      shell: docker build -t myapp:{{ image_tag }} .
      register: local_build
      changed_when: false

    - name: Verify Docker image
      shell: docker images myapp:{{ image_tag }} --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}"
      register: image_verify
      changed_when: false

    - name: Create complete Minikube deployment package
      copy:
        content: |
          # MINIKUBE DEPLOYMENT PACKAGE
          # Generated: {{ ansible_date_time.iso8601 }}
          # Image: myapp:{{ image_tag }}
          # Build: SUCCESS

          DEPLOYMENT INSTRUCTIONS:
          =======================

          1. START MINIKUBE:
             minikube start --driver=docker

          2. BUILD IMAGE IN MINIKUBE ENVIRONMENT:
             eval $(minikube docker-env)
             docker build -t myapp:{{ image_tag }} .

          3. DEPLOY TO KUBERNETES:
             kubectl create deployment myapp --image=myapp:{{ image_tag }} --port=5000
             kubectl expose deployment myapp --type=LoadBalancer --port=80 --target-port=5000

          4. GET APPLICATION URL:
             minikube service myapp --url

          QUICK DEPLOY SCRIPT:
          ===================
          Copy and run this complete script:

          minikube start --driver=docker
          eval $(minikube docker-env)
          docker build -t myapp:{{ image_tag }} .
          kubectl create deployment myapp --image=myapp:{{ image_tag }} --port=5000
          kubectl expose deployment myapp --type=LoadBalancer --port=80 --target-port=5000
          echo "ğŸŒ Your app is running at:"
          minikube service myapp --url

          VERIFICATION COMMANDS:
          =====================
          kubectl get pods
          kubectl get services
          kubectl get deployments
          minikube service list

          DOCKER IMAGE DETAILS:
          ====================
          {{ image_verify.stdout }}
        dest: "/tmp/minikube-deployment-{{ image_tag }}.txt"
      delegate_to: localhost

    - name: Create automated deployment script
      copy:
        content: |
          #!/bin/bash
          echo "ğŸš€ Automated Minikube Deployment for myapp:{{ image_tag }}"
          echo "=========================================================="
          
          # Check if Minikube is running
          if ! minikube status &>/dev/null; then
            echo "Starting Minikube..."
            minikube start --driver=docker
          else
            echo "Minikube is already running"
          fi
          
          # Build in Minikube environment
          echo "Building Docker image in Minikube environment..."
          eval $(minikube docker-env)
          docker build -t myapp:{{ image_tag }} .
          
          # Deploy to Kubernetes
          echo "Deploying to Kubernetes..."
          kubectl delete deployment myapp 2>/dev/null || true
          kubectl delete service myapp-service 2>/dev/null || true
          
          kubectl create deployment myapp --image=myapp:{{ image_tag }} --port=5000
          kubectl expose deployment myapp --type=LoadBalancer --port=80 --target-port=5000
          
          # Wait for deployment
          echo "Waiting for deployment to be ready..."
          sleep 15
          
          # Get URL
          echo "ğŸŒ APPLICATION DEPLOYED SUCCESSFULLY!"
          echo "URL: $(minikube service myapp --url)"
          echo ""
          echo "ğŸ“Š Current status:"
          kubectl get pods,services
        dest: "/tmp/deploy-{{ image_tag }}.sh"
        mode: 0755
      delegate_to: localhost

    - name: Display pipeline completion
      debug:
        msg: |
          âœ… CI/CD PIPELINE COMPLETED SUCCESSFULLY!
          ========================================
          
          ğŸ“¦ DOCKER IMAGE: myapp:{{ image_tag }} âœ“ BUILT
          ğŸ“‹ DEPLOYMENT PACKAGE: /tmp/minikube-deployment-{{ image_tag }}.txt âœ“ READY
          ğŸš€ DEPLOYMENT SCRIPT: /tmp/deploy-{{ image_tag }}.sh âœ“ READY
          
          ğŸ”§ NEXT STEPS:
          1. Run the deployment script on your host machine:
             bash /tmp/deploy-{{ image_tag }}.sh
          
          2. Or follow the instructions in:
             /tmp/minikube-deployment-{{ image_tag }}.txt
          
          ğŸ’¡ QUICK DEPLOYMENT:
             minikube start --driver=docker && eval $(minikube docker-env) && docker build -t myapp:{{ image_tag }} . && kubectl create deployment myapp --image=myapp:{{ image_tag }} --port=5000 && kubectl expose deployment myapp --type=LoadBalancer --port=80 --target-port=5000 && minikube service myapp --url

    - name: Show Docker image details
      debug:
        msg: "{{ image_verify.stdout }}"