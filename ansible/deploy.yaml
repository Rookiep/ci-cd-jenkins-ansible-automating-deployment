- name: Full CI/CD Pipeline + Auto Deployment to Minikube (Using YAML Manifests)
  hosts: localhost

  vars:
    # REMOVE BAD VARIABLE â€” DO NOT DEFINE image_tag AGAIN
    # image_tag: "{{ image_tag | default('latest') }}"

  tasks:

    - name: Set image_tag default if not passed
      set_fact:
        image_tag: "{{ image_tag | default('latest') }}"

    - name: Display pipeline start
      debug:
        msg: |
          ğŸš€ CI/CD PIPELINE STARTED
          Docker Image Tag: myapp:{{ image_tag }}

    # ----------------------------------------------------
    # SAFE PATH
    # ----------------------------------------------------
    - name: Compute safe Docker build path
      set_fact:
        build_path: "{{ (playbook_dir + '/..') | realpath }}"

    - name: Show build path
      debug:
        msg: "ğŸ“‚ Docker Build Path: {{ build_path }}"

    # ----------------------------------------------------
    # Start Minikube
    # ----------------------------------------------------
    - name: Start Minikube
      shell: minikube start --driver=docker
      changed_when: false

    # ----------------------------------------------------
    # Build Docker image inside Minikube
    # ----------------------------------------------------
    - name: Build Docker image inside Minikube
      shell: |
        eval $(minikube docker-env)
        docker build -t myapp:{{ image_tag }} "{{ build_path }}"
      args:
        executable: /bin/bash

    # ----------------------------------------------------
    # Update deployment.yaml image tag dynamically
    # ----------------------------------------------------
    - name: Patch image tag inside deployment.yaml
      replace:
        path: "{{ build_path }}/kubernetes/deployment.yaml"
        regexp: 'image: myapp:.*'
        replace: "image: myapp:{{ image_tag }}"

    # ----------------------------------------------------
    # Apply Kubernetes manifests
    # ----------------------------------------------------
    - name: Apply deployment
      shell: kubectl apply -f "{{ build_path }}/kubernetes/deployment.yaml"

    - name: Apply service
      shell: kubectl apply -f "{{ build_path }}/kubernetes/service.yaml"

    # ----------------------------------------------------
    # Wait for rollout
    # ----------------------------------------------------
    - name: Wait for deployment rollout
      shell: kubectl rollout status deployment/myapp --timeout=120s

    # ----------------------------------------------------
    # Get Minikube IP
    # ----------------------------------------------------
    - name: Get Minikube IP
      shell: minikube ip
      register: mk_ip
      changed_when: false

    # ----------------------------------------------------
    # Set final URL
    # ----------------------------------------------------
    - name: Construct final application URL
      set_fact:
        final_url: "http://{{ mk_ip.stdout }}:30080"

    - name: Show final URL
      debug:
        msg: |
          ğŸ‰ DEPLOYMENT SUCCESSFUL!
          ğŸŒ Application URL:
          ğŸ‘‰ {{ final_url }}