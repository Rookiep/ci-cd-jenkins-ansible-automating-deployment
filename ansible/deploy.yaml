---
- name: Deploy to Running Minikube Cluster
  hosts: localhost
  vars:
    image_tag: "{{ image_tag | default('latest') }}"
  
  tasks:
    - name: Verify Minikube is running
      shell: minikube status
      register: minikube_status
      changed_when: false

    - name: Verify kubectl access
      shell: kubectl cluster-info
      register: kubectl_status
      changed_when: false

    - name: Set Minikube Docker environment and build image
      shell: |
        eval $(minikube docker-env)
        docker build -t myapp:{{ image_tag }} .
      args:
        executable: /bin/bash
      register: build_result

    - name: Delete existing deployment if exists
      shell: kubectl delete deployment myapp 2>/dev/null || true
      ignore_errors: yes

    - name: Delete existing service if exists
      shell: kubectl delete service myapp-service 2>/dev/null || true
      ignore_errors: yes

    - name: Create Kubernetes deployment
      shell: kubectl create deployment myapp --image=myapp:{{ image_tag }} --port=5000
      register: deployment_result

    - name: Expose Kubernetes service
      shell: kubectl expose deployment myapp --type=LoadBalancer --port=80 --target-port=5000
      register: service_result

    - name: Wait for pods to be ready
      shell: |
        timeout 90s bash -c 'until kubectl get pods -l app=myapp 2>/dev/null | grep -q "Running"; do sleep 5; echo "Waiting for pods..."; done'
      ignore_errors: yes

    - name: Scale deployment to 3 replicas
      shell: kubectl scale deployment myapp --replicas=3
      ignore_errors: yes

    - name: Get application URL
      shell: minikube service myapp --url
      register: app_url
      ignore_errors: yes

    - name: Get deployment status
      shell: kubectl get pods,services,deployments -l app=myapp
      register: k8s_status
      changed_when: false

    - name: Display deployment success
      debug:
        msg: |
          ğŸ‰ SUCCESSFULLY DEPLOYED TO MINIKUBE!
          ====================================
          âœ… Image: myapp:{{ image_tag }}
          âœ… Minikube: RUNNING
          âœ… Kubernetes: ACCESSIBLE
          âœ… Deployment: CREATED
          âœ… Service: EXPOSED
          âœ… Status: RUNNING

          {% if app_url.stdout %}
          ğŸŒ APPLICATION URL: {{ app_url.stdout }}
          ğŸ’¡ Access your app: curl {{ app_url.stdout }}
          {% endif %}

          ğŸ“Š DEPLOYMENT STATUS:
          {{ k8s_status.stdout }}

          ğŸš€ Your application is now running on Minikube!